(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{384:function(t,s,a){"use strict";a.r(s);var e=a(2),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"文章相关资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文章相关资料"}},[t._v("#")]),t._v(" 文章相关资料")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/KieSun/react-interpretation",target:"_blank",rel:"noopener noreferrer"}},[t._v("React 16.8.6 源码中文注释"),a("OutboundLink")],1),t._v("，如果你想读源码但是又怕看不懂的话，可以通过这个仓库来学习")])]),t._v(" "),a("h2",{attrs:{id:"为什么需要调度？"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为什么需要调度？"}},[t._v("#")]),t._v(" 为什么需要调度？")]),t._v(" "),a("p",[t._v("大家都知道 JS 和渲染引擎是一个互斥关系。如果 JS 在执行代码，那么渲染引擎工作就会被停止。假如我们有一个很复杂的复合组件需要重新渲染，那么调用栈可能会很长")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-04-155141.png",alt:""}})]),t._v(" "),a("p",[t._v("调用栈过长，再加上如果中间进行了复杂的操作，就可能导致长时间阻塞渲染引擎带来不好的用户体验，调度就是来解决这个问题的。")]),t._v(" "),a("p",[t._v("React 会根据任务的优先级去分配各自的 "),a("code",[t._v("expirationTime")]),t._v("，在过期时间到来之前先去处理更高优先级的任务，并且高优先级的任务还可以打断低优先级的任务（因此会造成某些生命周期函数多次被执行），从而实现在不影响用户体验的情况下去分段计算更新（也就是时间分片）。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-04-155143.png",alt:""}})]),t._v(" "),a("h2",{attrs:{id:"react-如何实现调度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#react-如何实现调度"}},[t._v("#")]),t._v(" React 如何实现调度")]),t._v(" "),a("p",[t._v("React 实现调度主要靠两块内容：")]),t._v(" "),a("ol",[a("li",[t._v("计算任务的 expriationTime")]),t._v(" "),a("li",[t._v("实现 requestIdleCallback 的 polyfill 版本")])]),t._v(" "),a("p",[t._v("接下来就让笔者为大家一一介绍着两块内容。")]),t._v(" "),a("h3",{attrs:{id:"expriationtime"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#expriationtime"}},[t._v("#")]),t._v(" expriationTime")]),t._v(" "),a("p",[t._v("expriationTime 在前文简略的介绍过它的作用，这个时间可以帮助我们对比不同任务之间的优先级以及计算任务的 timeout。")]),t._v(" "),a("p",[t._v("那么这个时间是如何计算出来的呢？")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-04-155144.png",alt:""}})]),t._v(" "),a("p",[t._v("当前时间指的是 "),a("code",[t._v("performance.now()")]),t._v("，这个 API 会返回一个精确到毫秒级别的时间戳（当然也并不是高精度的），另外浏览器也并不是所有都兼容 "),a("code",[t._v("performance")]),t._v(" API 的。如果使用 "),a("code",[t._v("Date.now()")]),t._v(" 的话那么精度会更差，但是为了方便起见，我们这里统一把当前时间认为是 "),a("code",[t._v("performance.now()")]),t._v("。")]),t._v(" "),a("p",[t._v("常量指的是根据不同优先级得出的一个数值，React 内部目前总共有五种优先级，分别为：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" ImmediatePriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" UserBlockingPriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" NormalPriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" LowPriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" IdlePriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("它们各自的对应的数值都是不同的，具体的内容如下")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" maxSigned31BitInt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1073741823")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Times out immediately")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("IMMEDIATE_PRIORITY_TIMEOUT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Eventually times out")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("USER_BLOCKING_PRIORITY")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("250")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NORMAL_PRIORITY_TIMEOUT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LOW_PRIORITY_TIMEOUT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Never times out")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("IDLE_PRIORITY")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" maxSigned31BitInt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br")])]),a("p",[t._v("也就是说，假设当前时间为 5000 并且分别有两个优先级不同的任务要执行。前者属于 "),a("code",[t._v("ImmediatePriority")]),t._v("，后者属于 "),a("code",[t._v("UserBlockingPriority")]),t._v("，那么两个任务计算出来的时间分别为 "),a("code",[t._v("4999")]),t._v(" 和 "),a("code",[t._v("5250")]),t._v("。通过这个时间可以比对大小得出谁的优先级高，也可以通过减去当前时间获取任务的 timeout。")]),t._v(" "),a("h3",{attrs:{id:"requestidlecallback"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#requestidlecallback"}},[t._v("#")]),t._v(" requestIdleCallback")]),t._v(" "),a("p",[t._v("说完了 "),a("code",[t._v("expriationTime")]),t._v("，接下来的主题就是实现 "),a("code",[t._v("requestIdleCallback")]),t._v(" 了，我们首先来了解下该函数的作用")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-04-155145.png",alt:""}})]),t._v(" "),a("p",[t._v("该函数的回调方法会在浏览器的空闲时期依次调用， 可以让我们在事件循环中执行一些任务，并且不会对像动画和用户交互这样延迟敏感的事件产生影响。")]),t._v(" "),a("p",[t._v("在上图中我们也可以发现，该回调方法是在渲染以后才执行的。那么介绍完了函数的作用，接下来就来说说它的兼容性吧。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-04-155146.png",alt:""}})]),t._v(" "),a("p",[t._v("这个函数的兼容性并不是很好，并且它还有一个致命的缺陷：")]),t._v(" "),a("blockquote",[a("p",[t._v("requestIdleCallback is called only 20 times per second - Chrome on my 6x2 core Linux machine, it's not really useful for UI work.")])]),t._v(" "),a("p",[t._v("也就是说 "),a("code",[t._v("requestIdleCallback")]),t._v(" 只能一秒调用回调 20 次，这个完全满足不了现有的情况，由此 React 团队才打算自己实现这个函数。")]),t._v(" "),a("p",[t._v("如果你想了解更多关于替换 "),a("code",[t._v("requestIdleCallback")]),t._v(" 的内容，可以阅读 "),a("a",{attrs:{href:"https://github.com/facebook/react/issues/13206#issuecomment-418923831",target:"_blank",rel:"noopener noreferrer"}},[t._v("该 Issus"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"如何实现-requestidlecallback"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何实现-requestidlecallback"}},[t._v("#")]),t._v(" 如何实现 requestIdleCallback")]),t._v(" "),a("p",[t._v("实现 "),a("code",[t._v("requestIdleCallback")]),t._v(" 函数的核心只有一点，"),a("strong",[t._v("如何多次在浏览器空闲时且是渲染后才调用回调方法？")])]),t._v(" "),a("p",[t._v("说到多次执行，那么肯定得使用定时器了。在多种定时器中，唯有 "),a("code",[t._v("requestAnimationFrame")]),t._v(" 具备一定的精确度，因此 "),a("code",[t._v("requestAnimationFrame")]),t._v(" 就是当下实现 "),a("code",[t._v("requestIdleCallback")]),t._v(" 的一个步骤。")]),t._v(" "),a("p",[a("code",[t._v("requestAnimationFrame")]),t._v(" 的回调方法会在每次重绘前执行，另外它还存在一个瑕疵：页面处于后台时该回调函数不会执行，因此我们需要对于这种情况做个补救措施")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("rAFID "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("requestAnimationFrame")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("timestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// cancel the setTimeout")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("localClearTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rAFTimeoutID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("callback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("timestamp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrAFTimeoutID "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 定时 100 毫秒是算是一个最佳实践")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("localCancelAnimationFrame")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rAFID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("callback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getCurrentTime")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br")])]),a("p",[t._v("当 "),a("code",[t._v("requestAnimationFrame")]),t._v(" 不执行时，会有 "),a("code",[t._v("setTimeout")]),t._v(" 去补救，两个定时器内部可以互相取消对方。")]),t._v(" "),a("p",[t._v("使用 "),a("code",[t._v("requestAnimationFrame")]),t._v(" 只完成了多次执行这一步操作，接下来我们需要实现如何知道当前浏览器是否空闲呢？")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-04-155147.png",alt:""}})]),t._v(" "),a("p",[t._v("大家都知道在一帧当中，浏览器可能会响应用户的交互事件、执行 JS、进行渲染的一系列计算绘制。假设当前我们的浏览器支持 1 秒 60 帧，那么也就是说一帧的时间为 16.6 毫秒。如果以上这些操作超过了 16.6 毫秒，那么就会导致渲染没有完成并出现掉帧的情况，继而影响用户体验；如果以上这些操作没有耗时 16.6 毫秒的话，那么我们就认为当下存在空闲时间让我们可以去执行任务。")]),t._v(" "),a("p",[t._v("因此接下去我们需要计算出当前帧是否还有剩余时间让我们使用。")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" frameDeadline "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" previousFrameTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("33")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" activeFrameTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("33")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" nextFrameTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" performance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" frameDeadline "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" activeFrameTime\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\tnextFrameTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" activeFrameTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n\tpreviousFrameTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" activeFrameTime\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nextFrameTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tnextFrameTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tactiveFrameTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n\t\tnextFrameTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" previousFrameTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" previousFrameTime "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nextFrameTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tpreviousFrameTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" nextFrameTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br")])]),a("p",[t._v("以上这部分代码核心就是得出每一帧所耗时间及下一帧的时间。简单来说就是假设当前时间为 5000，浏览器支持 60 帧，那么 1 帧近似 16 毫秒，那么就会计算出下一帧时间为 5016。")]),t._v(" "),a("p",[t._v("得出下一帧时间以后，我们只需对比当前时间是否小于下一帧时间即可，这样就能清楚地知道是否还有空闲时间去执行任务。")]),t._v(" "),a("p",[t._v("那么最后一步操作就是如何在渲染以后才去执行任务。这里就需要用到事件循环的知识了")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-04-155148.png",alt:""}})]),t._v(" "),a("p",[t._v("想必大家都知道微任务宏任务的区别，这里就不再赘述这部分的内容了。从上图中我们可以发现，在渲染以后只有宏任务是最先会被执行的，因此宏任务就是我们实现这一步的操作了。")]),t._v(" "),a("p",[t._v("但是生成一个宏任务有很多种方式并且各自也有优先级，那么为了最快地执行任务，我们肯定得选择优先级高的方式。在这里我们选择了 "),a("code",[t._v("MessageChannel")]),t._v(" 来完成这个任务，不选择 "),a("code",[t._v("setImmediate")]),t._v(" 的原因是因为兼容性太差。")]),t._v(" "),a("p",[t._v("到这里为止，"),a("code",[t._v("requestAnimationFrame")]),t._v(" + 计算帧时间及下一帧时间 + "),a("code",[t._v("MessageChannel")]),t._v(" 就是我们实现 "),a("code",[t._v("requestIdleCallback")]),t._v(" 的三个关键点了。")]),t._v(" "),a("h2",{attrs:{id:"调度的流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#调度的流程"}},[t._v("#")]),t._v(" 调度的流程")]),t._v(" "),a("p",[t._v("上文说了这么多，这一小节我们将来梳理一遍调度的整个流程。")]),t._v(" "),a("ul",[a("li",[t._v("首先每个任务都会有各自的优先级，通过当前时间加上优先级所对应的常量我们可以计算出 "),a("code",[t._v("expriationTime")]),t._v("，"),a("strong",[t._v("高优先级的任务会打断低优先级任务")])]),t._v(" "),a("li",[t._v("在调度之前，判断当前任务"),a("strong",[t._v("是否过期")]),t._v("，过期的话无须调度，直接调用 "),a("code",[t._v("port.postMessage(undefined)")]),t._v("，这样就能在渲染后马上执行过期任务了")]),t._v(" "),a("li",[t._v("如果任务没有过期，就通过 "),a("code",[t._v("requestAnimationFrame")]),t._v(" 启动定时器，在重绘前调用回调方法")]),t._v(" "),a("li",[t._v("在回调方法中我们首先需要"),a("strong",[t._v("计算每一帧的时间以及下一帧的时间")]),t._v("，然后执行 "),a("code",[t._v("port.postMessage(undefined)")])]),t._v(" "),a("li",[a("code",[t._v("channel.port1.onmessage")]),t._v(" 会在渲染后被调用，在这个过程中我们首先需要去判断"),a("strong",[t._v("当前时间是否小于下一帧时间")]),t._v("。如果小于的话就代表我们尚有空余时间去执行任务；如果大于的话就代表当前帧已经没有空闲时间了，这时候我们需要去判断是否有任务过期，"),a("strong",[t._v("过期的话不管三七二十一还是得去执行这个任务")]),t._v("。如果没有过期的话，那就只能把这个任务丢到下一帧看能不能执行了")])]),t._v(" "),a("h2",{attrs:{id:"调度不会仅仅只有-react-拥有"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#调度不会仅仅只有-react-拥有"}},[t._v("#")]),t._v(" 调度不会仅仅只有 React 拥有")]),t._v(" "),a("p",[t._v("在未来，调度这个功能不会仅仅只有 React 才拥有。因为 React 已经尝试把调度这个模块单独抽离成一个库，这个库在未来能够被大家置入到自己的应用中去提高用户体验。")]),t._v(" "),a("p",[t._v("并且社区也有提案，希望浏览器能自带这方面的功能，具体可以阅读 "),a("a",{attrs:{href:"https://github.com/WICG/main-thread-scheduling",target:"_blank",rel:"noopener noreferrer"}},[t._v("这个库"),a("OutboundLink")],1),t._v("。")])])}),[],!1,null,null,null);s.default=n.exports}}]);